<html>
    <head>
        <style>
            *[data-page] {
                display: none;
            }
        </style>
        <script src="https://unpkg.com/uuid@latest/dist/umd/uuidv4.min.js"></script>
    </head>
    <body>
        <script>
            const State = {
                playerId: uuidv4(),
                currentPage: "list-lobbies",
                currentLobby: null,
                currentGame: null,
            };

            const Pages = {
                listLobbies: 'list-lobbies',
                lobby: 'lobby',
                game: 'game'
            };

            const API = {
                baseUrl: 'http://localhost:8080/api/v1',

                createLobby: async (name) => {
                    const response = await fetch(`${API.baseUrl}/lobbies`, {
                        method: 'POST',
                        body: JSON.stringify({ name }),
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Player-Id': State.playerId
                        }
                    });
                    return await response.json();
                },

                listLobbies: async () => {
                    const response = await fetch(`${API.baseUrl}/lobbies`);
                    return await response.json();
                },

                getLobbyDetails: async (id) => {
                    const response = await fetch(`${API.baseUrl}/lobbies/${id}`);
                    return await response.json();
                },

                joinLobby: async (id) => {
                    return await fetch(`${API.baseUrl}/lobbies/${id}/join`, {
                        method: 'POST',
                        headers: {
                            'X-Player-Id': State.playerId
                        }
                    });
                },

                startGame: async (id) => {
                    const response = await fetch(`${API.baseUrl}/lobbies/${id}/start`, {
                        method: 'POST'
                    });
                    return await response.json();
                }
            };
        </script>

        <div data-page="list-lobbies" data-bind="LobbyOverviewPage">
            <table id="lobbies">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Created by</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <button onclick="LobbyOverviewPage.createLobby()">Create lobby</button>
        </div>

        <div data-page="lobby" data-bind="LobbyPage">
            <p>Players</p>
            <ol data-list="players">
            </ol>

            <button onclick="gotoPage(Pages.listLobbies)">Back to lobby overview</button>
            <button onclick="LobbyPage.startGame(State.currentLobby)">Start game</button>
        </div>

        <div data-page="game" data-bind="GamePage">
            <p>Current game: <span data-content="game-id"></span></p>
        </div>

        <script>
            function hidePage(pageId) {
                const page = document.querySelector(`[data-page=${pageId}]`);

                if (page.dataset.bind) {
                    const lifecycleClass = eval(page.dataset.bind);
                    lifecycleClass.onunload && lifecycleClass.onunload();
                }

                page.style.display = 'none';
            }

            function showPage(pageId) {
                const page = document.querySelector(`[data-page=${pageId}]`);

                if (page.dataset.bind) {
                    const lifecycleClass = eval(page.dataset.bind);
                    lifecycleClass.onload && lifecycleClass.onload();
                }

                page.style.display = 'block';
            }

            function gotoPage(pageId) {
                hidePage(State.currentPage);
                showPage(pageId);
                State.currentPage = pageId;
            }

            class LobbyOverviewPage {
                static refreshInterval = null;

                static onload() {
                    this.refreshInterval = setInterval(() => this.refreshLobbies(), 5000);
                    this.refreshLobbies();
                }

                static onunload() {
                    clearInterval(this.refreshInterval);
                }

                static refreshLobbies() {
                    const lobbiesBody = document.querySelector('#lobbies tbody');

                    API.listLobbies().then(lobbies => {
                        lobbiesBody.innerHTML = '';

                        lobbies.forEach(({id, name, created_by}) => {
                            lobbiesBody.innerHTML += `<tr>
                            <td>${name}</td>
                            <td>${created_by}</td>
                            <td><button onclick="LobbyOverviewPage.joinLobby('${id}')">Join</button></td>
                            </tr>`;
                        });
                    });
                }

                static createLobby() {
                    let lobbyName = prompt("Please enter a name for your new lobby");

                    if (lobbyName) {
                        API.createLobby(lobbyName)
                            .then(response => {
                                alert(`Created lobby with id ${response.id}`);
                                this.refreshLobbies();
                            });
                    }
                }

                static joinLobby(lobbyId) {
                    API.joinLobby(lobbyId).then(() => {
                        State.currentLobby = lobbyId;
                        gotoPage(Pages.lobby);
                    });
                }
            }

            class LobbyPage {
                static refreshInterval = null;

                static onload() {
                    this.refreshInterval = setInterval(() => this.refreshLobby(), 5000);
                    this.refreshLobby();
                }

                static onunload() {
                    clearInterval(this.refreshInterval);
                }

                static refreshLobby() {
                    const playerList = document.querySelector('[data-list=players]');
                    API.getLobbyDetails(State.currentLobby).then(lobbyDetails => {
                        if (lobbyDetails.state === 'PLAYING') {
                            State.currentGame = lobbyDetails.game;
                            gotoPage(Pages.game);
                        } else {
                            playerList.innerHTML = '';

                            lobbyDetails.players.forEach(player => {
                                playerList.innerHTML += `<li>${player}</li>`
                            });
                        }
                    })
                }

                static startGame(lobbyId) {
                    API.startGame(lobbyId).then(({id}) => {
                        State.currentGame = id;
                        gotoPage(Pages.game);
                    });
                }
            }

            class GamePage {
                static onload() {
                    this.refreshGame();
                }

                static refreshGame() {
                    document.querySelectorAll("[data-content=game-id]").forEach(element => {
                        element.innerHTML = State.currentGame;
                    });
                }
            }

            gotoPage(Pages.listLobbies)
        </script>
    </body>
</html>